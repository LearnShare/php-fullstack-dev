# 2.11 匿名函数与闭包

## 目标

- 理解匿名函数、闭包、箭头函数的核心概念。
- 熟悉 `use` 关键字捕获变量、按值/按引用捕获的差异。
- 掌握闭包在回调、事件、依赖注入中的实战用法。
- 理解 PHP 闭包与 JavaScript 闭包的差异。

## 章节内容

本章分为两个独立小节，每节提供详细的概念解释、语法说明、参数列表和完整示例：

1. **[匿名函数基础](section-01-anonymous-functions.md)**：匿名函数的语法、定义、调用、在数组函数中使用、类型声明、立即执行函数（IIFE）及完整示例。

2. **[闭包与作用域](section-02-closures-scope.md)**：`use` 关键字、按值捕获、按引用捕获、闭包工厂、闭包与类、`Closure::bindTo()`、变量生命周期及完整示例。

## 匿名函数基础

```php
$logger = function (string $message): void {
    echo "[LOG] {$message}\n";
};
$logger('Service started');
```

## use 捕获变量

- **默认按值捕获**：`use ($variable)`，闭包内修改不会影响外部变量。
- **按引用捕获**：`use (&$variable)`，闭包内修改会影响外部变量。

## 箭头函数（PHP 7.4+）

- 语法：`fn ($arg) => expression`
- 自动按值捕获父作用域变量。
- 只能包含表达式，不能包含语句。

## 与 JavaScript 对比

如果你熟悉 JavaScript，理解 PHP 闭包的关键差异：

### 关键差异

1. **变量捕获**：
   - JavaScript：闭包自动捕获外部变量
   - PHP：必须使用 `use` 关键字显式捕获

2. **修改外部变量**：
   - JavaScript：箭头函数可以修改外部变量（如果变量不是 const）
   - PHP：箭头函数按值捕获，不能修改；需要使用 `use (&$var)` 按引用捕获

3. **语法**：
   - JavaScript：`(arg) => expression` 或 `function() { ... }`
   - PHP：`fn($arg) => expression` 或 `function() use ($var) { ... }`

## 学习建议

1. **按顺序学习**：先理解匿名函数，再学习闭包和作用域。

2. **重点掌握**：
   - 匿名函数的定义和调用
   - `use` 关键字的用法
   - 按值和按引用捕获的区别
   - 闭包工厂模式

3. **实践练习**：
   - 完成每小节后的练习题目
   - 实现实际的闭包应用场景
   - 比较 PHP 和 JavaScript 的闭包差异

4. **理解原理**：
   - 理解变量捕获的机制
   - 理解闭包如何延长变量生命周期
   - 理解闭包在函数式编程中的作用

## 完成本章后

- 能够定义和使用匿名函数。
- 理解闭包的概念和作用域机制。
- 掌握 `use` 关键字的用法和区别。
- 能够创建闭包工厂函数。
- 理解 PHP 闭包与 JavaScript 闭包的差异。
- 能够在实际项目中使用闭包解决实际问题。

## 相关章节

- **2.10 函数与作用域**：了解函数的基础知识。
- **2.4 数据类型**：了解可调用类型。
- **2.8 数组**：了解闭包在数组函数中的应用。
