# 2.3 变量与常量

## 目标

- 理解 PHP 变量的命名规则、生命周期与存储方式。
- 掌握引用赋值、可变变量、变量变量等进阶语法。
- 明确常量声明（`const`、`define`）与魔术常量的适用场景。

## 变量基础

- **命名**：以 `$` 开头，后接字母/下划线，再跟字母、数字或下划线，区分大小写。
- **作用域**：脚本级（全局）、函数级（局部）、静态（跨调用保持）。
- **动态类型**：变量无需显式声明类型，赋值时自动推断。

### 常用操作

```php
$name = 'Alice';
$count = 0;
$price = 19.9;
```

- `unset($name)`：销毁变量。
- `isset($name)`：存在且非 `null` 时返回 `true`。
- `empty($name)`：值为“空”时返回 `true`（空字符串、0、`null` 等）。

## 引用与可变变量

### 引用赋值

- **语法**：`$b =& $a;`
- **含义**：两个变量指向相同的 zval，更改其中任意一个都会影响另一个。

```php
$a = 5;
$b =& $a;
$b = 10;
// $a === 10
```

### 引用参数

- **语法**：`function addOne(int &$value): void`
- **用途**：在函数内部直接修改实参的值，常用于迭代器或聚合统计。

### 可变变量（Variable Variables）

- **语法**：`$$var` 表示值为变量名的变量。
- **示例**：
  ```php
  $name = 'user';
  $user = 'Alice';
  echo $$name; // 输出 Alice
  ```
- **注意**：可读性差，除动态配置或模板场景外不建议使用。

## 常量

### `const` 与 `define`

- `const NAME = 'value';`：编译期常量，只能用于顶级作用域或类内。
- `define('NAME', 'value');`：运行期常量，可在条件语句中定义。

对比表：

| 特性       | `const`                 | `define`              |
| :--------- | :---------------------- | :-------------------- |
| 定义时机   | 编译期                  | 运行期                |
| 作用域     | 文件/类内部             | 全局命名空间          |
| 语法支持   | 仅标识符                | 可以动态拼接          |
| 支持数组   | PHP 5.6+ 可定义数组常量 | 支持                  |

### 魔术常量

- `__FILE__`：当前文件绝对路径。
- `__DIR__`：当前文件所在目录。
- `__LINE__`：当前行号。
- `__FUNCTION__` / `__METHOD__`：函数/方法名。
- `__CLASS__` / `__TRAIT__` / `__NAMESPACE__`：反映结构与命名空间。

示例：

```php
printf(
    "Log from %s (line %d)\n",
    __FILE__,
    __LINE__
);
```

## 全局与静态

### `global`

- 在函数内访问全局变量需要 `global $var;` 或使用 `$GLOBALS['var']`。

```php
$counter = 0;
function inc(): void
{
    global $counter;
    $counter++;
}
```

### 静态变量

- **语法**：`static $count = 0;`
- **用途**：在函数中保存状态，又无需引入全局变量。

```php
function nextId(): int
{
    static $id = 0;
    return ++$id;
}
```

## 最佳实践

1. 始终启用 `declare(strict_types=1);`，减少隐式转换带来的混乱。
2. 使用明确的命名与类型提示（PHP 7.4+ 支持属性类型声明）。
3. 慎用引用与可变变量，必要时添加注释说明意图。
4. 对常量采用全大写、下划线分隔的命名，例如 `APP_ENV`。

## 练习

1. 编写 `Counter` 类，使用静态属性记录实例数量，并提供 `getCount()` 方法。
2. 创建一个函数 `swap(&$a, &$b)`，通过引用交换两个变量的值。
3. 使用魔术常量记录每次函数调用的来源文件与行号，输出到日志文件。
