# 1.2.2 运行模式与验证

## 概述

PHP 支持多种运行模式，每种模式适用于不同的场景。理解这些模式的差异对于选择合适的部署方案至关重要。本节介绍 PHP 的各种运行模式、特点、使用方法和验证方式。

**章节类型**：配置性章节

**主要内容**：
- 运行模式对比（CLI、内置服务器、PHP-FPM、常驻运行时）
- CLI 模式的使用和检测
- 内置 Web 服务器的启动和路由
- PHP-FPM 模式的配置
- 常驻运行时的介绍
- 运行验证方法

## 特性

- **多种运行模式**：支持 CLI、Web 服务器、FPM、常驻运行时等多种模式
- **灵活部署**：可根据场景选择最适合的运行模式
- **性能优化**：不同模式针对不同场景进行了优化

## 配置步骤/语法

### 运行模式对比

| 模式 | 用途 | 特点 | 适用场景 |
| :--- | :--- | :--- | :------- |
| CLI | 命令行执行 | 单次执行，脚本结束后进程退出 | 脚本、迁移、队列 |
| 内置服务器 | 开发测试 | 单线程，不适合生产环境 | 快速演示、本地开发 |
| PHP-FPM | Web 应用 | 进程池管理，高性能 | 生产环境标准 |
| 常驻运行时 | 高性能场景 | 进程常驻内存，处理多个请求 | 高并发 API、WebSocket |

### CLI 模式（命令行）

**特点**：
- 用途：执行脚本、运行迁移、处理队列任务
- 特点：单次执行，脚本结束后进程退出
- 类比：类似 Node.js 的 CLI 脚本

**基本使用**：
- 执行脚本：`php script.php`
- 执行单行代码：`php -r "echo 'Hello';"`
- 检测 CLI 模式：`php_sapi_name() === 'cli'`

**代码示例**：
- CLI 脚本示例
- CLI 模式检测示例

### 内置 Web 服务器

**特点**：
- 用途：开发测试、快速演示
- 特点：单线程，不适合生产环境
- 限制：性能有限，功能简单

**基本使用**：
- 启动服务器：`php -S localhost:8000 -t public`
- 指定路由脚本：`php -S localhost:8000 router.php`

**路由脚本示例**：
- 简单的路由处理
- 文件存在性检查

### PHP-FPM 模式

**特点**：
- 用途：生产环境 Web 应用
- 特点：进程池管理，高性能
- 配置：需要 Nginx 或 Apache 配合

**基本配置**：
- PHP-FPM 配置文件位置
- 进程池配置
- 与 Nginx 的配合

### 常驻运行时

**特点**：
- 用途：高性能场景
- 特点：进程常驻内存，处理多个请求
- 工具：RoadRunner、FrankenPHP、OpenSwoole

**基本介绍**：
- 常驻运行时的优势
- 适用场景
- 与 PHP-FPM 的对比

### 运行验证

**验证方法**：
- `php_sapi_name()`：检测当前运行模式
- `php -i`：查看配置信息
- `php -m`：查看已加载的扩展
- 检查进程：`ps aux | grep php`

**验证示例**：
- CLI 模式验证
- Web 模式验证
- FPM 模式验证

## 注意事项

- **生产环境**：不要使用内置 Web 服务器，应使用 PHP-FPM
- **性能考虑**：常驻运行时适合高并发场景，但需要特殊配置
- **模式检测**：在代码中检测运行模式，避免在 CLI 模式下执行 Web 相关代码
- **配置差异**：不同模式的配置可能不同，需要注意区分

## 常见问题

### 问题 1：内置服务器无法访问
- **原因**：端口被占用或防火墙阻止
- **解决**：检查端口占用，更换端口或关闭防火墙

### 问题 2：PHP-FPM 无法启动
- **原因**：配置文件错误或权限问题
- **解决**：检查配置文件语法，确保有执行权限

### 问题 3：CLI 和 Web 模式行为不一致
- **原因**：配置不同或环境变量不同
- **解决**：统一配置文件，检查环境变量

## 输出结果说明

**CLI 模式验证示例**：
```bash
$ php -r "echo php_sapi_name();"
cli
```

**内置服务器启动示例**：
```bash
$ php -S localhost:8000
PHP 8.3.0 Development Server (http://localhost:8000) started
```

## 最佳实践

- 开发环境使用内置服务器或 PHP-FPM
- 生产环境必须使用 PHP-FPM 或常驻运行时
- 在代码中检测运行模式，避免模式相关的错误
- 记录运行模式配置，便于问题排查
