# 9.1.5 业务逻辑设计

## 一、租户管理业务逻辑

### 1.1 租户注册逻辑

#### 1.1.1 注册流程

**业务规则：**

1. **输入验证**
   - 企业名称：2-50 个字符，必填
   - 邮箱：有效邮箱格式，全局唯一，必填
   - 密码：至少 8 位，包含大小写字母和数字，必填
   - 子域名：3-20 个字符，只能包含字母、数字、连字符，全局唯一，必填

2. **子域名检查**
   - 检查子域名是否已被使用
   - 检查子域名是否符合规范
   - 检查保留字（如：www, api, admin, mail 等）

3. **创建租户**
   - 生成租户 ID（UUID）
   - 创建租户记录
   - 状态设置为 `active`

4. **创建管理员用户**
   - 生成用户 ID（UUID）
   - 创建用户记录
   - 密码使用 Argon2ID 加密
   - 邮箱状态为未验证

5. **分配角色**
   - 创建"超级管理员"角色（如果不存在）
   - 将用户分配为超级管理员

6. **创建默认订阅**
   - 创建免费试用订阅（14 天）
   - 关联到租户

7. **发送验证邮件**
   - 生成验证令牌
   - 发送验证邮件
   - 令牌有效期 24 小时

#### 1.1.2 注册失败处理

**失败场景：**

1. **子域名已存在**
   - 返回错误："子域名已被使用，请选择其他子域名"
   - 建议可用的子域名

2. **邮箱已存在**
   - 返回错误："邮箱已被注册"
   - 提供登录链接

3. **密码不符合规则**
   - 返回错误："密码必须至少 8 位，包含大小写字母和数字"

4. **系统错误**
   - 记录错误日志
   - 返回通用错误："注册失败，请稍后重试"

### 1.2 租户识别逻辑

#### 1.2.1 识别流程

**步骤：**

1. **提取请求信息**
   - 从请求头获取 `Host`
   - 从请求头获取 `X-Tenant-ID`（如果存在）

2. **优先级判断**
   - 如果存在 `X-Tenant-ID`，直接使用
   - 否则，从 `Host` 提取子域名或自定义域名

3. **查询租户**
   - 根据子域名或自定义域名查询租户
   - 如果不存在，返回错误

4. **验证租户状态**
   - 如果状态为 `suspended`，返回错误
   - 如果状态为 `cancelled`，返回错误

5. **设置租户上下文**
   - 将租户信息存储到请求上下文
   - 后续所有查询自动使用此租户

#### 1.2.2 识别失败处理

**失败场景：**

1. **无法识别租户**
   - 返回 400 错误："无法识别租户"
   - 提示用户检查访问地址

2. **租户不存在**
   - 返回 404 错误："租户不存在"

3. **租户被暂停**
   - 返回 403 错误："租户已被暂停，请联系管理员"

## 二、用户认证业务逻辑

### 2.1 用户注册逻辑

#### 2.1.1 注册流程

**业务规则：**

1. **输入验证**
   - 姓名：2-50 个字符，必填
   - 邮箱：有效邮箱格式，租户内唯一，必填
   - 密码：至少 8 位，包含大小写字母和数字，必填

2. **邮箱检查**
   - 检查邮箱是否属于当前租户
   - 检查邮箱是否已被使用（租户内）

3. **创建用户**
   - 生成用户 ID（UUID）
   - 创建用户记录
   - 密码使用 Argon2ID 加密
   - 状态设置为 `inactive`（未激活）
   - 默认角色为"成员"

4. **发送验证邮件**
   - 生成验证令牌
   - 发送验证邮件
   - 令牌有效期 24 小时

#### 2.1.2 邮箱验证逻辑

**验证流程：**

1. **接收验证请求**
   - 用户点击邮件中的验证链接
   - 链接包含：`token` 参数

2. **验证令牌**
   - 从缓存或数据库查询令牌
   - 检查令牌是否有效
   - 检查令牌是否过期

3. **激活用户**
   - 更新用户状态为 `active`
   - 更新 `email_verified_at` 时间戳
   - 删除验证令牌

4. **自动登录**
   - 生成 JWT Token
   - 返回 Token 给客户端
   - 跳转到工作空间列表

### 2.2 用户登录逻辑

#### 2.2.1 登录流程

**业务规则：**

1. **接收登录请求**
   - 邮箱：`user@example.com`
   - 密码：`Password123`
   - 租户：已通过中间件识别

2. **查找用户**
   ```sql
   SELECT * FROM users 
   WHERE tenant_id = ? AND email = ?
   ```

3. **验证密码**
   - 使用 `password_verify()` 验证
   - 如果失败：
     - 增加失败次数
     - 失败 5 次后锁定账号 30 分钟
     - 返回错误："邮箱或密码错误"

4. **检查用户状态**
   - 如果状态为 `suspended`，返回错误："账号已被暂停"
   - 如果状态为 `inactive`，可以登录但功能受限

5. **生成 Token**
   - 包含：`user_id`, `tenant_id`, `roles`, `email`
   - 有效期：24 小时
   - 签名：使用密钥签名

6. **更新登录信息**
   - 更新 `last_login_at`
   - 重置失败次数
   - 记录登录日志

#### 2.2.2 登录失败处理

**失败场景：**

1. **用户不存在**
   - 返回错误："邮箱或密码错误"（不透露用户是否存在）

2. **密码错误**
   - 增加失败次数
   - 失败 5 次后锁定账号
   - 返回错误："邮箱或密码错误"

3. **账号被锁定**
   - 返回错误："账号已被锁定，请 30 分钟后重试"
   - 显示剩余锁定时间

4. **账号被暂停**
   - 返回错误："账号已被暂停，请联系管理员"

### 2.3 密码重置逻辑

#### 2.3.1 重置流程

**业务规则：**

1. **请求重置**
   - 用户输入邮箱
   - 系统查找用户（邮箱 + 租户）

2. **生成重置令牌**
   - 生成随机令牌（32 字节）
   - 保存到缓存（有效期 1 小时）
   - 键名：`password_reset:{user_id}`

3. **发送重置邮件**
   - 邮件包含重置链接
   - 链接：`/reset-password?token=xxx`
   - 即使用户不存在，也返回成功（安全考虑）

4. **验证令牌**
   - 用户点击邮件链接
   - 从缓存查询令牌
   - 验证令牌是否有效

5. **重置密码**
   - 用户输入新密码
   - 验证新密码规则
   - 更新密码哈希
   - 删除重置令牌
   - 撤销所有现有 Token（安全考虑）

6. **自动登录**
   - 生成新的 JWT Token
   - 返回 Token 给客户端

## 三、订阅计费业务逻辑

### 3.1 订阅创建逻辑

#### 3.1.1 创建流程

**业务规则：**

1. **选择套餐**
   - 用户选择套餐（例如：基础版）
   - 系统查询套餐信息
   - 验证套餐是否可用

2. **检查现有订阅**
   - 查询租户的当前订阅
   - 如果已有活跃订阅：
     - 如果是升级，创建新订阅，旧订阅在周期结束后取消
     - 如果是降级，标记旧订阅在周期结束后降级

3. **创建 Stripe 订阅**
   - 获取或创建 Stripe Customer
   - 创建 Stripe Subscription
   - 获取支付方式（如果不存在）

4. **创建本地订阅记录**
   - 生成订阅 ID（UUID）
   - 创建订阅记录
   - 关联到租户和套餐
   - 状态设置为 `active`

5. **更新租户信息**
   - 更新租户的 `subscription_id`
   - 更新租户的套餐限制

6. **发送确认邮件**
   - 发送订阅确认邮件
   - 包含订阅详情和发票

#### 3.1.2 支付处理逻辑

**Stripe Webhook 处理：**

1. **接收 Webhook**
   - Stripe 发送事件到我们的 Webhook 端点
   - 验证 Webhook 签名

2. **处理事件类型**

   **`customer.subscription.created`**
   - 订阅创建成功
   - 更新本地订阅状态为 `active`

   **`customer.subscription.updated`**
   - 订阅信息更新
   - 更新本地订阅信息（周期、状态等）

   **`customer.subscription.deleted`**
   - 订阅被删除
   - 更新本地订阅状态为 `cancelled`

   **`invoice.payment_succeeded`**
   - 支付成功
   - 生成发票记录
   - 发送发票邮件

   **`invoice.payment_failed`**
   - 支付失败
   - 更新订阅状态为 `past_due`
   - 发送支付失败通知

### 3.2 订阅取消逻辑

#### 3.2.1 取消流程

**业务规则：**

1. **用户请求取消**
   - 用户点击"取消订阅"
   - 系统查询当前订阅

2. **取消选项**
   - **立即取消**：立即停止服务，不退款
   - **周期结束时取消**：当前周期内继续使用，周期结束后停止

3. **处理取消**
   - 如果立即取消：
     - 调用 Stripe API 立即取消订阅
     - 更新本地订阅状态为 `cancelled`
     - 立即降级到免费版
   - 如果周期结束时取消：
     - 调用 Stripe API 标记订阅在周期结束时取消
     - 更新本地订阅 `cancel_at_period_end = true`
     - 周期结束后自动降级

4. **发送确认邮件**
   - 发送取消确认邮件
   - 包含取消时间和后续步骤

### 3.3 套餐限制检查逻辑

#### 3.3.1 限制类型

**用户数量限制：**
- 免费版：最多 5 个用户
- 基础版：最多 20 个用户
- 高级版：最多 100 个用户
- 企业版：无限制

**工作空间数量限制：**
- 免费版：最多 3 个工作空间
- 其他版本：无限制

**存储空间限制：**
- 免费版：1GB
- 基础版：10GB
- 高级版：50GB
- 企业版：无限制

#### 3.3.2 限制检查流程

**场景：用户尝试邀请新成员**

1. **查询当前用户数**
   ```sql
   SELECT COUNT(*) FROM users WHERE tenant_id = ?
   ```

2. **查询套餐限制**
   ```sql
   SELECT limits FROM plans 
   WHERE id = (SELECT plan_id FROM subscriptions WHERE tenant_id = ?)
   ```

3. **检查限制**
   - 如果当前用户数 >= 限制，返回错误
   - 错误信息："已达到用户数量限制，请升级套餐"

4. **允许操作**
   - 如果未达到限制，允许邀请

## 四、工作空间管理业务逻辑

### 4.1 工作空间创建逻辑

#### 4.1.1 创建流程

**业务规则：**

1. **权限检查**
   - 检查用户是否有 `workspaces.create` 权限
   - 如果没有权限，返回错误

2. **限制检查**
   - 查询租户的套餐限制
   - 查询当前工作空间数量
   - 如果达到限制，返回错误

3. **输入验证**
   - 工作空间名称：2-50 个字符，租户内唯一
   - 描述：可选，最多 500 个字符

4. **创建工作空间**
   - 生成工作空间 ID（UUID）
   - 创建记录
   - 创建者自动成为所有者
   - 创建者自动加入工作空间成员列表

5. **创建默认内容**（可选）
   - 创建默认项目
   - 创建欢迎文档

### 4.2 成员邀请逻辑

#### 4.2.1 邀请流程

**业务规则：**

1. **权限检查**
   - 检查用户是否有邀请成员的权限
   - 通常需要工作空间管理员或所有者权限

2. **用户数量限制检查**
   - 检查租户是否达到用户数量限制
   - 如果达到限制，返回错误

3. **查找或创建用户**
   - 如果邮箱对应的用户已存在（同一租户）：
     - 直接使用现有用户
   - 如果用户不存在：
     - 创建新用户账号
     - 状态设置为 `inactive`
     - 发送注册邀请邮件

4. **创建工作空间成员关系**
   - 创建 `workspace_members` 记录
   - 角色设置为邀请时选择的角色

5. **发送邀请邮件**
   - 如果用户已存在且已激活：
     - 发送加入工作空间通知邮件
   - 如果用户不存在或未激活：
     - 发送注册邀请邮件

6. **加入工作空间**
   - 用户点击邮件链接
   - 如果未登录，先登录
   - 验证邀请令牌
   - 将用户添加到工作空间成员列表
   - 跳转到工作空间详情页面

## 五、业务规则总结

### 5.1 数据隔离规则

- 所有业务数据查询必须包含 `tenant_id` 过滤
- 用户只能访问同一租户内的数据
- 跨租户访问必须返回错误

### 5.2 权限控制规则

- 所有操作都需要权限验证
- 权限检查顺序：租户级 → 工作空间级 → 资源级
- 没有权限的操作返回 403 错误

### 5.3 资源限制规则

- 所有资源创建前检查套餐限制
- 达到限制时返回错误，提示升级套餐
- 降级套餐时，如果资源超过新限制，需要先清理资源

### 5.4 状态管理规则

- 租户状态影响所有用户访问
- 用户状态只影响该用户
- 订阅状态影响租户功能可用性
