# 9.1.1 SaaS 平台需求规划

## 一、业务背景与问题

### 1.1 业务场景

假设我们要构建一个**项目管理 SaaS 平台**，类似于 Trello、Asana 或 Monday.com。这个平台需要支持多个企业客户使用，每个企业都是独立的租户。

### 1.2 核心问题

#### 问题一：如何让多个企业客户使用同一个系统？

**场景描述：**
- 公司 A 注册了我们的服务，创建了账号，开始使用项目管理功能
- 公司 B 也注册了服务，创建了账号
- 公司 A 和公司 B 的数据必须完全隔离，不能互相看到对方的数据

**需要解决的问题：**
- 如何识别当前请求来自哪个企业？
- 如何确保公司 A 的用户只能看到公司 A 的数据？
- 如何防止数据泄露和误访问？

#### 问题二：如何管理企业内的用户和权限？

**场景描述：**
- 公司 A 有 10 个员工，需要不同的权限
  - 老板需要看到所有项目和数据
  - 项目经理需要管理项目但不能删除公司
  - 普通员工只能查看和编辑分配给自己的任务
- 公司 B 有 50 个员工，权限需求更复杂

**需要解决的问题：**
- 如何定义不同的角色（老板、项目经理、员工）？
- 如何给用户分配角色？
- 如何控制用户能做什么、不能做什么？

#### 问题三：如何收费？

**场景描述：**
- 公司 A 有 10 个用户，选择基础套餐，每月 99 元
- 公司 B 有 50 个用户，选择高级套餐，每月 299 元
- 公司 C 有 200 个用户，选择企业套餐，每月 999 元

**需要解决的问题：**
- 如何让客户选择套餐并支付？
- 如何自动续费？
- 如何限制用户数量（基础套餐最多 10 个用户）？
- 如何生成发票？

#### 问题四：如何支持团队协作？

**场景描述：**
- 公司 A 有多个部门，每个部门需要独立的工作空间
- 市场部的工作空间只有市场部员工能看到
- 技术部的工作空间只有技术部员工能看到
- 但老板可以看到所有工作空间

**需要解决的问题：**
- 如何创建工作空间？
- 如何邀请成员加入工作空间？
- 如何控制工作空间的访问权限？

## 二、用户需求分析

### 2.1 企业管理员（租户管理员）

**用户画像：**
- 通常是公司的老板或 IT 管理员
- 负责注册账号、管理订阅、管理团队成员

**核心需求：**

1. **注册和登录**
   - 能够注册新账号（创建租户）
   - 能够登录系统
   - 能够重置密码

2. **订阅管理**
   - 能够查看当前订阅状态
   - 能够选择不同的套餐
   - 能够升级或降级套餐
   - 能够取消订阅
   - 能够查看账单和发票

3. **团队管理**
   - 能够邀请员工加入
   - 能够给员工分配角色
   - 能够移除员工
   - 能够查看团队成员列表

4. **工作空间管理**
   - 能够创建工作空间
   - 能够设置工作空间名称和描述
   - 能够删除工作空间
   - 能够管理工作空间成员

### 2.2 普通用户（企业员工）

**用户画像：**
- 企业内的普通员工
- 使用系统进行日常工作

**核心需求：**

1. **账号管理**
   - 能够登录系统
   - 能够修改个人信息
   - 能够修改密码

2. **工作空间使用**
   - 能够查看自己被邀请加入的工作空间
   - 能够在工作空间内创建和管理项目
   - 能够查看工作空间内的其他成员

3. **权限控制**
   - 只能看到自己有权限访问的数据
   - 只能执行自己有权限的操作

### 2.3 系统管理员（平台运营方）

**用户画像：**
- 我们自己的运营团队
   - 需要查看所有租户的使用情况
   - 需要处理客户问题
   - 需要查看收入报表

**核心需求：**

1. **租户管理**
   - 能够查看所有租户列表
   - 能够查看租户详情
   - 能够暂停或恢复租户

2. **数据分析**
   - 能够查看用户增长趋势
   - 能够查看收入报表
   - 能够查看使用统计

## 三、功能需求清单

### 3.1 租户管理功能

#### 3.1.1 租户注册

**功能描述：**
企业管理员注册新账号，创建新的租户。

**用户操作流程：**
1. 访问注册页面
2. 填写企业名称、邮箱、密码
3. 选择子域名（如：company-a.oursaas.com）
4. 提交注册
5. 收到验证邮件
6. 点击邮件中的链接完成验证
7. 自动登录系统

**业务规则：**
- 子域名必须唯一
- 邮箱必须唯一（全局唯一，不是租户内唯一）
- 密码必须至少 8 位，包含大小写字母和数字
- 注册后自动创建免费试用套餐（14 天）

#### 3.1.2 租户识别

**功能描述：**
系统能够自动识别当前请求来自哪个租户。

**识别方式：**
1. **子域名识别**（主要方式）
   - `company-a.oursaas.com` → 识别为 company-a 租户
   - `company-b.oursaas.com` → 识别为 company-b 租户

2. **自定义域名识别**（高级功能）
   - `pm.company-a.com` → 识别为 company-a 租户
   - 需要租户配置 DNS 记录

3. **Header 识别**（API 调用）
   - `X-Tenant-ID: company-a` → 识别为 company-a 租户

**业务规则：**
- 如果无法识别租户，返回错误
- 如果租户被暂停，返回错误
- 所有数据查询自动添加租户过滤

### 3.2 用户认证功能

#### 3.2.1 用户注册

**功能描述：**
企业管理员注册后，可以邀请员工注册，或者员工自己注册。

**用户操作流程：**
1. 访问注册页面（或点击邀请链接）
2. 填写姓名、邮箱、密码
3. 提交注册
4. 收到验证邮件
5. 点击邮件中的链接完成验证
6. 自动登录系统

**业务规则：**
- 邮箱在租户内必须唯一
- 注册后需要管理员激活（或自动激活，取决于设置）
- 注册后默认角色为"成员"

#### 3.2.2 用户登录

**功能描述：**
用户使用邮箱和密码登录系统。

**用户操作流程：**
1. 访问登录页面
2. 输入邮箱和密码
3. 点击登录
4. 系统验证账号密码
5. 生成登录令牌（Token）
6. 跳转到工作空间列表页面

**业务规则：**
- 密码错误 5 次后锁定账号 30 分钟
- 登录后记录最后登录时间
- Token 有效期 24 小时，可刷新

#### 3.2.3 密码重置

**功能描述：**
用户忘记密码时，可以通过邮箱重置密码。

**用户操作流程：**
1. 访问登录页面，点击"忘记密码"
2. 输入邮箱
3. 收到重置密码邮件
4. 点击邮件中的链接
5. 输入新密码
6. 提交后自动登录

**业务规则：**
- 重置链接有效期 1 小时
- 重置链接只能使用一次
- 新密码必须符合密码规则

### 3.3 权限管理功能

#### 3.3.1 角色定义

**功能描述：**
系统预定义几种角色，每个角色有不同的权限。

**角色列表：**

1. **超级管理员**（租户所有者）
   - 所有权限
   - 可以管理订阅
   - 可以删除租户

2. **管理员**
   - 可以管理用户
   - 可以管理工作空间
   - 不能管理订阅

3. **项目经理**
   - 可以创建和管理项目
   - 可以分配任务
   - 不能删除工作空间

4. **成员**
   - 可以查看分配给自己的任务
   - 可以编辑自己的任务
   - 不能创建项目

5. **查看者**
   - 只能查看，不能编辑
   - 不能创建任何内容

**业务规则：**
- 每个租户至少有一个超级管理员
- 角色可以自定义（高级功能）
- 权限可以细化到具体操作（创建、编辑、删除、查看）

#### 3.3.2 用户角色分配

**功能描述：**
管理员可以给用户分配角色。

**用户操作流程：**
1. 管理员进入用户管理页面
2. 选择要修改的用户
3. 选择新角色
4. 保存

**业务规则：**
- 不能移除最后一个超级管理员
- 角色变更立即生效
- 可以给用户分配多个角色（取并集）

### 3.4 订阅计费功能

#### 3.4.1 套餐选择

**功能描述：**
租户可以选择不同的订阅套餐。

**套餐列表：**

1. **免费版**
   - 最多 5 个用户
   - 最多 3 个工作空间
   - 基础功能

2. **基础版**（99 元/月）
   - 最多 20 个用户
   - 无限工作空间
   - 所有功能
   - 邮件支持

3. **高级版**（299 元/月）
   - 最多 100 个用户
   - 无限工作空间
   - 所有功能
   - 优先支持
   - 高级报表

4. **企业版**（999 元/月）
   - 无限用户
   - 无限工作空间
   - 所有功能
   - 专属支持
   - 自定义域名
   - API 访问

**业务规则：**
- 新注册用户自动获得 14 天免费试用（高级版功能）
- 试用期结束后自动降级到免费版
- 可以随时升级或降级套餐
- 降级时如果用户数超过限制，需要先移除多余用户

#### 3.4.2 支付处理

**功能描述：**
租户选择套餐后，需要支付费用。

**用户操作流程：**
1. 进入订阅管理页面
2. 选择套餐
3. 点击"升级"或"订阅"
4. 跳转到支付页面
5. 输入支付信息（信用卡）
6. 确认支付
7. 支付成功后，订阅立即生效

**业务规则：**
- 支持信用卡支付（通过 Stripe）
- 支付成功后自动创建订阅
- 每月自动续费
- 可以随时取消订阅（当前周期结束后生效）

#### 3.4.3 订阅管理

**功能描述：**
租户可以查看和管理自己的订阅。

**功能包括：**
- 查看当前订阅状态
- 查看订阅到期时间
- 取消订阅
- 恢复已取消的订阅
- 查看账单历史
- 下载发票

**业务规则：**
- 取消订阅后，当前周期内仍可使用
- 周期结束后自动降级到免费版
- 可以随时恢复订阅

### 3.5 工作空间管理功能

#### 3.5.1 创建工作空间

**功能描述：**
用户可以创建工作空间，用于组织项目。

**用户操作流程：**
1. 进入工作空间列表页面
2. 点击"创建工作空间"
3. 输入工作空间名称和描述
4. 选择可见性（私有/公开）
5. 保存

**业务规则：**
- 每个租户可以创建的工作空间数量受套餐限制
- 创建者自动成为工作空间所有者
- 工作空间名称在租户内必须唯一

#### 3.5.2 成员管理

**功能描述：**
工作空间所有者可以邀请成员加入工作空间。

**用户操作流程：**
1. 进入工作空间设置页面
2. 点击"邀请成员"
3. 输入邮箱（可以是租户内的用户，也可以是新用户）
4. 选择角色（工作空间内的角色）
5. 发送邀请
6. 被邀请人收到邮件
7. 点击邮件中的链接加入工作空间

**业务规则：**
- 只能邀请同一租户内的用户
- 工作空间成员数量受租户套餐限制
- 可以移除成员
- 成员可以主动离开工作空间

## 四、非功能性需求

### 4.1 性能需求

- **响应时间**：页面加载时间 < 2 秒，API 响应时间 < 200ms
- **并发支持**：支持至少 1000 个并发用户
- **可扩展性**：能够从 100 个租户扩展到 10 万个租户

### 4.2 安全需求

- **数据隔离**：确保不同租户的数据完全隔离
- **数据加密**：敏感数据加密存储
- **访问控制**：严格的权限控制，防止越权访问
- **审计日志**：记录所有重要操作

### 4.3 可用性需求

- **系统可用性**：99.9%（每年停机时间 < 8.76 小时）
- **数据备份**：每天自动备份，保留 30 天
- **灾难恢复**：RTO < 4 小时，RPO < 1 小时

### 4.4 用户体验需求

- **界面友好**：现代化、直观的用户界面
- **响应式设计**：支持桌面、平板、手机
- **多语言支持**：支持中文、英文（可选）

## 五、约束条件

### 5.1 技术约束

- 必须使用 PHP 开发
- 必须使用 MySQL 数据库
- 必须支持 Docker 部署

### 5.2 业务约束

- 必须支持 Stripe 支付
- 必须符合 GDPR 数据保护要求
- 必须支持数据导出（用户要求时）

### 5.3 时间约束

- MVP 版本：8 周内完成
- 完整版本：14 周内完成

## 六、成功标准

### 6.1 功能完整性

- 所有核心功能正常工作
- 所有业务流程能够完整走通
- 没有阻塞性 Bug

### 6.2 性能指标

- 页面加载时间 < 2 秒
- API 响应时间 < 200ms
- 支持 1000 并发用户

### 6.3 质量标准

- 代码测试覆盖率 > 80%
- 无严重安全漏洞
- 用户体验评分 > 4.5/5
