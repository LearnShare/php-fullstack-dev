# 9.1.2 功能、页面和使用流程设计

## 一、核心功能模块

### 1.1 租户管理模块

**功能概述：**
管理企业租户的注册、识别、配置等。

**主要功能：**
- 租户注册
- 租户识别（子域名、自定义域名）
- 租户配置管理
- 租户状态管理（激活、暂停、取消）

### 1.2 用户认证模块

**功能概述：**
处理用户的注册、登录、密码管理等。

**主要功能：**
- 用户注册
- 用户登录
- 密码重置
- 邮箱验证
- Token 管理（JWT）

### 1.3 权限管理模块

**功能概述：**
管理角色、权限分配和权限验证。

**主要功能：**
- 角色定义
- 权限定义
- 用户角色分配
- 权限验证中间件

### 1.4 订阅计费模块

**功能概述：**
管理套餐、订阅、支付和账单。

**主要功能：**
- 套餐管理
- 订阅创建和更新
- 支付处理（Stripe 集成）
- 账单和发票管理
- Webhook 处理

### 1.5 工作空间管理模块

**功能概述：**
管理工作空间的创建、成员管理、权限控制。

**主要功能：**
- 工作空间创建
- 工作空间设置
- 成员邀请和管理
- 工作空间权限控制

## 二、页面设计

### 2.1 公开页面（无需登录）

#### 2.1.1 首页

**页面路径：** `/`

**页面内容：**
- 产品介绍
- 功能特性
- 价格套餐
- 注册按钮
- 登录链接

**用户操作：**
- 点击"免费注册"跳转到注册页面
- 点击"登录"跳转到登录页面

#### 2.1.2 注册页面

**页面路径：** `/register`

**页面内容：**
- 企业名称输入框
- 邮箱输入框
- 密码输入框
- 确认密码输入框
- 子域名输入框（显示预览：`[子域名].oursaas.com`）
- 服务条款复选框
- 注册按钮

**用户操作流程：**
1. 填写企业名称
2. 填写邮箱
3. 输入密码
4. 确认密码
5. 输入子域名（系统检查是否可用）
6. 勾选服务条款
7. 点击"注册"
8. 系统验证输入
9. 发送验证邮件
10. 显示"请查收邮件"提示

**验证规则：**
- 企业名称：必填，2-50 个字符
- 邮箱：必填，有效邮箱格式，全局唯一
- 密码：必填，至少 8 位，包含大小写字母和数字
- 确认密码：必须与密码一致
- 子域名：必填，3-20 个字符，只能包含字母、数字、连字符，全局唯一

#### 2.1.3 登录页面

**页面路径：** `/login`

**页面内容：**
- 邮箱输入框
- 密码输入框
- "记住我"复选框
- 登录按钮
- "忘记密码"链接

**用户操作流程：**
1. 输入邮箱
2. 输入密码
3. （可选）勾选"记住我"
4. 点击"登录"
5. 系统验证账号密码
6. 登录成功，跳转到工作空间列表页面

**错误处理：**
- 邮箱或密码错误：显示"邮箱或密码错误"
- 账号被锁定：显示"账号已被锁定，请 30 分钟后重试"
- 账号未激活：显示"账号未激活，请查收邮件"

#### 2.1.4 密码重置页面

**页面路径：** `/forgot-password`

**页面内容：**
- 邮箱输入框
- "发送重置链接"按钮

**用户操作流程：**
1. 输入邮箱
2. 点击"发送重置链接"
3. 显示"如果邮箱存在，我们将发送重置链接"
4. 收到邮件，点击链接
5. 跳转到重置密码页面

#### 2.1.5 重置密码页面

**页面路径：** `/reset-password?token=xxx`

**页面内容：**
- 新密码输入框
- 确认密码输入框
- "重置密码"按钮

**用户操作流程：**
1. 输入新密码
2. 确认新密码
3. 点击"重置密码"
4. 密码重置成功，自动登录
5. 跳转到工作空间列表页面

### 2.2 认证后页面（需要登录）

#### 2.2.1 工作空间列表页面

**页面路径：** `/workspaces`

**页面内容：**
- 顶部导航栏（用户头像、设置、退出）
- 左侧边栏（工作空间列表、创建按钮）
- 主内容区（工作空间卡片列表）
- 每个工作空间卡片显示：
  - 工作空间名称
  - 工作空间描述
  - 成员数量
  - 项目数量
  - 最后访问时间
  - 操作按钮（进入、设置、删除）

**用户操作流程：**
1. 登录后自动跳转到此页面
2. 查看所有有权限访问的工作空间
3. 点击工作空间卡片进入工作空间详情
4. 点击"创建工作空间"按钮创建新工作空间

**权限控制：**
- 只能看到自己有权限访问的工作空间
- 只有管理员才能看到"创建工作空间"按钮（受套餐限制）

#### 2.2.2 工作空间详情页面

**页面路径：** `/workspaces/{id}`

**页面内容：**
- 顶部导航栏（工作空间名称、成员、设置）
- 左侧菜单（项目、成员、设置）
- 主内容区（根据菜单显示不同内容）

**用户操作流程：**
1. 从工作空间列表点击进入
2. 查看工作空间内的项目列表
3. 可以创建新项目、编辑项目、删除项目
4. 可以查看和管理成员

#### 2.2.3 用户设置页面

**页面路径：** `/settings/profile`

**页面内容：**
- 个人信息表单：
  - 姓名
  - 邮箱（只读）
  - 头像上传
- 密码修改表单：
  - 当前密码
  - 新密码
  - 确认新密码
- 保存按钮

**用户操作流程：**
1. 点击顶部导航栏的用户头像
2. 选择"设置"
3. 修改个人信息
4. 点击"保存"
5. 显示"保存成功"提示

#### 2.2.4 订阅管理页面

**页面路径：** `/settings/billing`

**页面内容：**
- 当前套餐信息：
  - 套餐名称
  - 套餐价格
  - 订阅状态
  - 到期时间
  - 用户数量限制
  - 工作空间数量限制
- 套餐列表（可升级的套餐）
- 支付方式管理
- 账单历史
- 取消订阅按钮

**用户操作流程：**
1. 查看当前套餐信息
2. 选择新套餐，点击"升级"
3. 跳转到支付页面
4. 输入支付信息
5. 确认支付
6. 支付成功后返回，显示新套餐信息

**权限控制：**
- 只有租户管理员（超级管理员）才能访问此页面

#### 2.2.5 团队管理页面

**页面路径：** `/settings/team`

**页面内容：**
- 团队成员列表：
  - 头像
  - 姓名
  - 邮箱
  - 角色
  - 加入时间
  - 操作（编辑角色、移除）
- "邀请成员"按钮
- 用户数量统计（当前/限制）

**用户操作流程：**
1. 查看团队成员列表
2. 点击"邀请成员"
3. 输入邮箱，选择角色
4. 发送邀请
5. 被邀请人收到邮件，点击链接加入

**权限控制：**
- 只有管理员才能邀请成员和修改角色
- 普通成员只能查看列表

## 三、核心使用流程

### 3.1 新用户注册流程

**流程图：**

```
开始
  ↓
访问首页
  ↓
点击"免费注册"
  ↓
填写注册信息（企业名称、邮箱、密码、子域名）
  ↓
提交注册
  ↓
系统验证输入
  ↓
创建租户和用户
  ↓
发送验证邮件
  ↓
用户查收邮件
  ↓
点击验证链接
  ↓
邮箱验证成功
  ↓
自动登录
  ↓
跳转到工作空间列表
  ↓
结束
```

**详细步骤：**

1. **用户访问首页**
   - 用户打开 `https://oursaas.com`
   - 看到产品介绍和价格

2. **点击注册**
   - 用户点击"免费注册"按钮
   - 跳转到注册页面

3. **填写注册信息**
   - 用户填写：
     - 企业名称：例如"ABC 公司"
     - 邮箱：例如 `admin@abc.com`
     - 密码：例如 `Password123`
     - 子域名：例如 `abc`
   - 系统实时检查子域名是否可用
   - 显示预览：`abc.oursaas.com`

4. **提交注册**
   - 用户点击"注册"按钮
   - 系统验证所有输入
   - 如果验证失败，显示错误信息

5. **创建租户和用户**
   - 系统创建租户记录（ID: `tenant_abc_123`）
   - 系统创建用户记录（ID: `user_admin_456`，角色：超级管理员）
   - 系统创建默认工作空间

6. **发送验证邮件**
   - 系统生成验证令牌
   - 发送邮件到 `admin@abc.com`
   - 邮件包含验证链接：`https://abc.oursaas.com/verify-email?token=xxx`

7. **用户验证邮箱**
   - 用户查收邮件
   - 点击验证链接
   - 系统验证令牌
   - 标记邮箱为已验证

8. **自动登录**
   - 系统生成 JWT Token
   - 设置 Cookie
   - 跳转到工作空间列表页面

### 3.2 用户登录流程

**流程图：**

```
开始
  ↓
访问登录页面
  ↓
输入邮箱和密码
  ↓
提交登录
  ↓
系统验证账号密码
  ↓
检查账号状态
  ↓
生成 Token
  ↓
记录登录时间
  ↓
跳转到工作空间列表
  ↓
结束
```

**详细步骤：**

1. **访问登录页面**
   - 用户访问 `https://abc.oursaas.com/login`
   - 系统识别租户为 `abc`

2. **输入凭据**
   - 用户输入邮箱：`admin@abc.com`
   - 用户输入密码：`Password123`

3. **提交登录**
   - 用户点击"登录"按钮
   - 系统验证邮箱和密码

4. **验证过程**
   - 系统查找用户（邮箱 + 租户 ID）
   - 验证密码哈希
   - 检查账号状态（是否激活、是否被锁定）

5. **生成 Token**
   - 登录成功，生成 JWT Token
   - Token 包含：用户 ID、租户 ID、角色、过期时间
   - 设置 Cookie 或返回 Token

6. **记录登录**
   - 更新用户最后登录时间
   - 记录登录日志

7. **跳转**
   - 跳转到工作空间列表页面

### 3.3 创建工作空间流程

**流程图：**

```
开始
  ↓
进入工作空间列表
  ↓
点击"创建工作空间"
  ↓
填写工作空间信息
  ↓
提交创建
  ↓
系统验证权限和限制
  ↓
创建工作空间
  ↓
创建者自动成为所有者
  ↓
跳转到工作空间详情
  ↓
结束
```

**详细步骤：**

1. **进入工作空间列表**
   - 用户登录后，访问 `/workspaces`
   - 系统检查用户是否有创建权限
   - 系统检查是否超过套餐限制

2. **点击创建按钮**
   - 用户点击"创建工作空间"按钮
   - 弹出创建表单

3. **填写信息**
   - 工作空间名称：例如"市场部"
   - 工作空间描述：例如"市场部的工作空间"
   - 可见性：私有/公开

4. **提交创建**
   - 用户点击"创建"按钮
   - 系统验证输入

5. **验证权限和限制**
   - 检查用户是否有创建权限
   - 检查租户是否超过工作空间数量限制
   - 如果超过限制，显示错误信息

6. **创建工作空间**
   - 系统创建工作空间记录
   - 创建者自动成为工作空间所有者
   - 创建默认项目（可选）

7. **跳转**
   - 跳转到新创建的工作空间详情页面

### 3.4 邀请成员流程

**流程图：**

```
开始
  ↓
进入工作空间设置
  ↓
点击"邀请成员"
  ↓
输入邮箱和选择角色
  ↓
发送邀请
  ↓
系统检查用户是否存在
  ↓
发送邀请邮件
  ↓
被邀请人查收邮件
  ↓
点击邀请链接
  ↓
加入工作空间
  ↓
结束
```

**详细步骤：**

1. **进入工作空间设置**
   - 工作空间所有者或管理员进入 `/workspaces/{id}/settings`
   - 点击"成员"标签

2. **点击邀请**
   - 点击"邀请成员"按钮
   - 弹出邀请表单

3. **填写邀请信息**
   - 输入邮箱：例如 `member@abc.com`
   - 选择角色：例如"成员"
   - 点击"发送邀请"

4. **系统处理**
   - 系统检查邮箱是否属于同一租户
   - 如果用户不存在，创建用户账号（待激活）
   - 如果用户存在，直接关联

5. **发送邀请邮件**
   - 生成邀请令牌
   - 发送邮件到 `member@abc.com`
   - 邮件包含加入链接：`https://abc.oursaas.com/workspaces/{id}/join?token=xxx`

6. **被邀请人加入**
   - 被邀请人查收邮件
   - 点击加入链接
   - 如果未登录，先登录
   - 系统验证令牌
   - 将用户添加到工作空间成员列表
   - 跳转到工作空间详情页面

### 3.5 订阅升级流程

**流程图：**

```
开始
  ↓
进入订阅管理页面
  ↓
查看当前套餐
  ↓
选择新套餐
  ↓
点击"升级"
  ↓
跳转到支付页面
  ↓
输入支付信息
  ↓
确认支付
  ↓
Stripe 处理支付
  ↓
支付成功
  ↓
更新订阅信息
  ↓
发送确认邮件
  ↓
返回订阅管理页面
  ↓
结束
```

**详细步骤：**

1. **进入订阅管理**
   - 租户管理员访问 `/settings/billing`
   - 查看当前套餐信息

2. **选择新套餐**
   - 查看可用套餐列表
   - 选择要升级的套餐（例如：从基础版升级到高级版）
   - 点击"升级"按钮

3. **跳转支付**
   - 系统生成支付会话
   - 跳转到 Stripe 支付页面（或内嵌支付表单）

4. **输入支付信息**
   - 用户输入信用卡信息
   - 输入账单地址

5. **确认支付**
   - 用户点击"支付"
   - Stripe 验证支付信息
   - 处理支付

6. **支付成功**
   - Stripe 返回支付成功
   - 系统接收 Webhook 通知
   - 更新订阅记录
   - 更新租户套餐信息

7. **发送确认**
   - 发送确认邮件给管理员
   - 生成发票

8. **返回**
   - 返回订阅管理页面
   - 显示新套餐信息

## 四、页面交互设计

### 4.1 导航结构

```
顶部导航栏
├── Logo（点击返回首页）
├── 工作空间切换器（下拉菜单）
├── 通知图标（显示未读通知数量）
└── 用户菜单（下拉菜单）
    ├── 个人设置
    ├── 订阅管理（仅管理员）
    ├── 团队管理（仅管理员）
    └── 退出登录

左侧边栏（工作空间内）
├── 工作空间名称
├── 项目列表
├── 成员
├── 设置
└── 其他功能菜单
```

### 4.2 响应式设计

**桌面端（> 1024px）：**
- 左侧边栏固定显示
- 主内容区自适应宽度
- 顶部导航栏完整显示

**平板端（768px - 1024px）：**
- 左侧边栏可折叠
- 主内容区占满剩余空间
- 顶部导航栏简化显示

**移动端（< 768px）：**
- 左侧边栏隐藏，通过菜单按钮打开
- 主内容区全屏显示
- 顶部导航栏只显示关键信息

### 4.3 错误处理

**表单验证错误：**
- 实时显示错误信息（输入框下方红色文字）
- 提交时汇总所有错误
- 错误信息清晰明确

**权限错误：**
- 显示"您没有权限执行此操作"
- 提供返回链接

**系统错误：**
- 显示友好的错误页面
- 记录错误日志
- 提供联系支持的方式
